# Use a Microsoft Windows Server Core image with Python pre-installed.
# This image is large and requires a Windows-based GitLab Runner.
image: mcr.microsoft.com/windows/servercore:ltsc2022-py310

# Global variables
variables:
  APP_NAME: "Toliss Cabin Announcements.exe"
  MAIN_SCRIPT: "cabinselection.py"

# --- Stages Definition ---
stages:
  - build

# ----------------------------------
# Windows 64-bit PyInstaller Build Job
# ----------------------------------
build_windows_x64_executable:
  stage: build
  
  # Only run on Git tags (releases)
  rules:
    - if: $CI_COMMIT_TAG
      when: always

  script:
    - echo "Starting 64-bit Windows PyInstaller build for tag %CI_COMMIT_TAG%..."
    
    # 1. Install Dependencies
    # In Windows environment, use 'pip' directly.
    # Note: Use PowerShell syntax if your Windows image defaults to it. Below uses cmd/batch syntax.
    - python -m pip install --upgrade pip
    - pip install pyinstaller
    - pip install -r requirements.txt
    
    # 2. Run PyInstaller for 64-bit
    # By default, running PyInstaller on a 64-bit Windows OS/Container creates a 64-bit executable.
    # The '--onefile' option creates a single .exe.
    - pyinstaller --onefile --name %APP_NAME% --clean %MAIN_SCRIPT%

    # 3. Verification
    - echo "Verifying build output..."
    - dir dist
    
    # 4. Cleanup
    - rmdir /s /q build
    - del "%APP_NAME%.spec"

    - echo "64-bit Windows build completed successfully. Executable is %APP_NAME%.exe"

  # Define the artifacts to be saved
  artifacts:
    name: "%APP_NAME%"
    paths:
      # The output path is the same regardless of OS
      - dist/
    when: on_success
    # Artifacts will be kept indefinitely