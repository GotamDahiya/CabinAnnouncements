# Use a standard, stable Linux image with Python
image: python:3.10-slim

# Global variables
variables:
  APP_NAME: "Toliss Test.exe"
  MAIN_SCRIPT: "cabinselection.py"

# Define the pipeline stage
stages:
  - windows-executable

# ----------------------------------------------------
# Windows 64-bit PyInstaller Build Job (Wine on Linux)
# ----------------------------------------------------
create_executable:
  stage: windows-executable
  
  # Only run on Git tags (releases)
  rules:
    - if: $CI_COMMIT_TAG
      when: always

  script:
    - echo "Starting cross-platform 64-bit Windows PyInstaller build using Wine..."

    # Update packages
    - apt-get update
    
    
    - dpkg --add-architecture i386

    - apt-get install wine
    # Set the Wine environment to 64-bit (win64) explicitly
    - WINEARCH=win64 winecfg # Initializes the Wine prefix as 64-bit

    ## 2. Install Python Dependencies *inside* the Wine environment
    
    # The 'wine python -m pip' structure installs Windows-compatible dependencies.
    - wine python -m pip install --upgrade pip
    - wine python -m pip install pyinstaller
    - wine python -m pip install -r requirements.txt
    
    ## 3. Run PyInstaller
    
    # PyInstaller executed within the win64 environment will produce a 64-bit EXE.
    - wine pyinstaller --onefile --name $APP_NAME --clean $MAIN_SCRIPT

    ## 4. Verification and Cleanup
    
    - echo "Verifying build output..."
    - ls -l dist/
    
    - rm -rf build/
    - rm -f $APP_NAME.spec

  artifacts:
    name: "$APP_NAME"
    paths:
      - dist/ # Contains the final .exe file
    when: on_success