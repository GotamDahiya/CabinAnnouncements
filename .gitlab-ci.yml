image: mcr.microsoft.com/windows/servercore:ltsc2022

# Global variables
variables:
  APP_NAME: "Toliss Test.exe"
  MAIN_SCRIPT: "cabinselection.py"
  PYTHON_VERSION: "3.13.8" # Specify a stable Python 3.10 version

# --- Stages Definition ---
stages:
  - build

# ----------------------------------------------------
# Windows 64-bit PyInstaller Build Job (Requires Windows Docker Runner)
# ----------------------------------------------------
build_windows_x64_executable:
  stage: build
 
   # Only run on Git tags (releases)
  rules:
    - if: $CI_COMMIT_TAG
      when: always

  # Specify the shell to use PowerShell for easier environment setup
  shell: powershell

  script:
    - Write-Host "Starting 64-bit Windows PyInstaller build..."

    # 1. Download and Install Python 3.10
    - Write-Host "Installing Python $env:PYTHON_VERSION..."
    - Invoke-WebRequest -Uri "https://www.python.org/ftp/python/$env:PYTHON_VERSION/python-$env:PYTHON_VERSION-amd64.exe" -OutFile "C:\python_installer.exe"
    # Execute the installer silently for all users and add to PATH
    - Start-Process "C:\python_installer.exe" -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait
    
    # Add Python installation folder to PATH temporarily for the current job session
    - $env:Path = "$env:Path;C:\Python$($env:PYTHON_VERSION.replace('.', ''))\;C:\Python$($env:PYTHON_VERSION.replace('.', ''))\Scripts"
    - Write-Host "Python Path: $env:Path" # Verify path
    
    # 2. Install PyInstaller and Dependencies
    - pip install --upgrade pip
    - pip install pyinstaller
    - pip install -r requirements.txt
    
    # 3. Run PyInstaller
    # PyInstaller executed on a 64-bit Windows host produces a 64-bit EXE.
    - pyinstaller --onefile --name $env:APP_NAME --clean $env:MAIN_SCRIPT

    # 4. Verification and Cleanup (using PowerShell commands)
    - Write-Host "Verifying build output..."
    - Get-ChildItem dist
    
    - Remove-Item -Recurse -Force build
    - Remove-Item "$env:APP_NAME.spec"

  artifacts:
    name: "$env:APP_NAME"
    paths:
      - dist/
    when: on_success